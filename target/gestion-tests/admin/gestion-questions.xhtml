<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:p="http://primefaces.org/ui"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
<h:head>
    <title>ISGA | Banque de Questions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <h:outputStylesheet library="css" name="styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&amp;display=swap" rel="stylesheet" />
</h:head>
<h:body>
    <f:metadata>
        <f:event type="preRenderView" listener="#{adminBean.chargerQuestions}" />
        <f:event type="preRenderView" listener="#{adminBean.chargerThemes}" />
    </f:metadata>

    <div class="admin-layout">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="admin-logo">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üöÄ</div>
                <h2>ISGA</h2>
                <span style="opacity: 0.6; font-size: 0.8rem; letter-spacing: 1px;">MANAGEMENT</span>
            </div>
            <h:form>
                <p:menu style="width: 100%; border: none; background: transparent;">
                    <p:menuitem value="Vue d'ensemble" icon="pi pi-th-large" outcome="dashboard" />
                    <p:menuitem value="Banque de Questions" icon="pi pi-database" outcome="gestion-questions"
                        styleClass="active-menu-item" />
                    <p:menuitem value="Planning &amp; Cr√©neaux" icon="pi pi-calendar" outcome="gestion-creneaux" />
                    <p:menuitem value="R√©sultats &amp; Stats" icon="pi pi-chart-bar" outcome="recherche-resultats" />

                    <p:separator style="background: rgba(255,255,255,0.1); margin: 1rem 0;" />
                    <p:menuitem value="D√©connexion" icon="pi pi-power-off" action="#{adminBean.seDeconnecter}"
                        style="color: #fda4af !important;" />
                </p:menu>
            </h:form>
        </div>

        <div class="admin-content">
            <h:form id="questionForm" class="animate-entry">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Banque de Questions</h1>
                        <p style="color: var(--text-muted);">G√©rez les questions, les th√®mes et les r√©ponses.</p>
                    </div>
                    <div>
                        <p:commandButton value="Nouvelle Question" icon="pi pi-plus" styleClass="btn-primary-lg"
                            style="background: var(--brand-primary) !important; color: white !important; width: auto; padding: 0.8rem 1.5rem !important;"
                            onclick="PF('newQuestionDialog').show(); return false;" type="button">
                        </p:commandButton>
                    </div>
                </div>

                <p:messages id="messages" showDetail="true" closable="true">
                    <p:autoUpdate />
                </p:messages>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">#{adminBean.questions != null ? adminBean.questions.size() : 0}</div>
                        <div class="stat-label">Total Questions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">#{adminBean.nombreThemes}</div>
                        <div class="stat-label">Th√®mes Actifs</div>
                    </div>
                </div>

                <div style="background: white; padding: 2rem; border-radius: 16px; box-shadow: var(--shadow-soft);">
                    <p:dataTable id="questionsTable" value="#{adminBean.questions}" var="question" paginator="true"
                        rows="10" emptyMessage="Aucune question trouv√©e." paginatorPosition="bottom">

                        <p:column headerText="Th√®me" sortBy="#{question.theme.nom}" style="width: 15%;">
                            <span
                                style="background: #eef2ff; color: var(--brand-primary); padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                                #{question.theme.nom}
                            </span>
                        </p:column>

                        <p:column headerText="√ânonc√©">
                            <h:outputText value="#{question.texte}" style="font-weight: 500;" />
                        </p:column>

                        <p:column headerText="Type" style="width: 15%;">
                            <h:outputText
                                value="#{question.type == 'CHOIX_UNIQUE' ? 'Choix Unique' : 'Choix Multiple'}" />
                        </p:column>

                        <p:column headerText="Actions" style="width: 140px; text-align: right;">
                            <p:commandButton icon="pi pi-pencil" action="#{adminBean.selectionnerQuestion(question)}"
                                update="editQuestionForm" oncomplete="PF('editQuestionDialog').show();"
                                styleClass="p-button-rounded p-button-text p-button-info" style="margin-right: 5px;" />
                            <p:commandButton icon="pi pi-trash" action="#{adminBean.supprimerQuestion(question)}"
                                update="questionForm:questionsTable questionForm:messages"
                                styleClass="p-button-rounded p-button-text p-button-danger"
                                onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette question ?');">
                                <p:ajax update="questionForm:questionsTable questionForm:messages" />
                            </p:commandButton>
                        </p:column>
                    </p:dataTable>
                </div>

            </h:form>

            <!-- DIALOG: Nouvelle Question -->
            <p:dialog id="newQuestionDialog" widgetVar="newQuestionDialog" header="Nouvelle Question" modal="true"
                width="700" responsive="true">
                <h:form id="newQuestionForm">
                    <div class="p-fluid">
                        <!-- Th√®me -->
                        <div class="p-field" style="margin-bottom: 1rem;">
                            <label for="newTheme">Th√®me *</label>
                            <p:selectOneMenu id="newTheme" value="#{adminBean.themeId}" required="true">
                                <f:selectItem itemLabel="-- S√©lectionnez un th√®me --" itemValue="#{null}"
                                    noSelectionOption="true" />
                                <f:selectItems value="#{adminBean.themes}" var="t" itemLabel="#{t.nom}"
                                    itemValue="#{t.id}" />
                            </p:selectOneMenu>
                        </div>

                        <!-- Type -->
                        <div class="p-field" style="margin-bottom: 1rem;">
                            <label for="newType">Type de question *</label>
                            <p:selectOneMenu id="newType" value="#{adminBean.nouvelleQuestion.type}" required="true">
                                <f:selectItem itemLabel="-- S√©lectionnez un type --" itemValue="#{null}"
                                    noSelectionOption="true" />
                                <f:selectItem itemLabel="Choix Unique" itemValue="CHOIX_UNIQUE" />
                                <f:selectItem itemLabel="Choix Multiple" itemValue="CHOIX_MULTIPLE" />
                            </p:selectOneMenu>
                        </div>

                        <!-- Texte question -->
                        <div class="p-field" style="margin-bottom: 1.5rem;">
                            <label for="newTexte">√ânonc√© de la question *</label>
                            <p:inputTextarea id="newTexte" value="#{adminBean.nouvelleQuestion.texte}" rows="3"
                                required="true" maxlength="500" />
                        </div>

                        <!-- SECTION R√âPONSES -->
                        <div style="border-top: 1px solid #e0e0e0; padding-top: 1rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: var(--brand-primary);">R√©ponses</h4>

                            <!-- Liste des r√©ponses -->
                            <ui:repeat value="#{adminBean.reponsesTemp}" var="rep">
                                <div
                                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem; padding: 8px; background: #{rep.correcte ? '#d4edda' : '#f8f9fa'}; border-radius: 6px;">
                                    <p:commandButton icon="#{rep.correcte ? 'pi pi-check-circle' : 'pi pi-circle'}"
                                        action="#{adminBean.toggleCorrect(rep)}" update="newQuestionForm"
                                        styleClass="p-button-rounded p-button-text #{rep.correcte ? 'p-button-success' : 'p-button-secondary'}"
                                        style="flex-shrink: 0;" title="Marquer comme correcte" />
                                    <span
                                        style="flex: 1; #{rep.correcte ? 'font-weight: 600; color: #155724;' : 'color: #495057;'}">
                                        #{rep.texte}
                                    </span>
                                    <p:commandButton icon="pi pi-trash" action="#{adminBean.supprimerReponseTemp(rep)}"
                                        update="newQuestionForm"
                                        styleClass="p-button-rounded p-button-text p-button-danger"
                                        style="flex-shrink: 0;" />
                                </div>
                            </ui:repeat>

                            <!-- Message si aucune r√©ponse -->
                            <h:panelGroup rendered="#{empty adminBean.reponsesTemp}">
                                <div style="text-align: center; padding: 1rem; color: #6c757d; font-style: italic;">
                                    Aucune r√©ponse ajout√©e. Ajoutez au moins 2 r√©ponses ci-dessous.
                                </div>
                            </h:panelGroup>

                            <!-- Formulaire ajout r√©ponse -->
                            <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                                <div style="display: flex; gap: 10px; align-items: flex-end;">
                                    <div style="flex: 1;">
                                        <label for="newRepTexte"
                                            style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Texte de la
                                            r√©ponse</label>
                                        <p:inputText id="newRepTexte" value="#{adminBean.texteNouvelleReponse}"
                                            style="width: 100%;" placeholder="Saisissez une r√©ponse..." />
                                    </div>
                                    <div style="flex-shrink: 0;">
                                        <p:selectBooleanCheckbox id="newRepCorrecte"
                                            value="#{adminBean.nouvelleReponseCorrecte}" />
                                        <label for="newRepCorrecte" style="margin-left: 5px;">Correcte</label>
                                    </div>
                                    <p:commandButton value="Ajouter" icon="pi pi-plus"
                                        action="#{adminBean.ajouterReponseTemp}" update="newQuestionForm"
                                        styleClass="p-button-sm p-button-info" style="flex-shrink: 0;" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: right; margin-top: 1.5rem;">
                        <p:commandButton value="Annuler" icon="pi pi-times"
                            onclick="PF('newQuestionDialog').hide(); return false;" type="button"
                            styleClass="p-button-text" style="margin-right: 10px;" />
                        <p:commandButton value="Cr√©er Question" icon="pi pi-check" action="#{adminBean.ajouterQuestion}"
                            update="questionForm:questionsTable questionForm:messages"
                            oncomplete="if (args &amp;&amp; !args.validationFailed) PF('newQuestionDialog').hide();"
                            styleClass="p-button-success" />
                    </div>
                </h:form>
            </p:dialog>
            <!-- DIALOG: √âditer Question -->
            <p:dialog id="editQuestionDialog" widgetVar="editQuestionDialog" header="Modifier Question" modal="true"
                width="700" responsive="true">
                <h:form id="editQuestionForm">
                    <div class="p-fluid">
                        <!-- Th√®me -->
                        <div class="p-field" style="margin-bottom: 1rem;">
                            <label for="editTheme">Th√®me *</label>
                            <p:selectOneMenu id="editTheme" value="#{adminBean.themeId}" required="true">
                                <f:selectItems value="#{adminBean.themes}" var="t" itemLabel="#{t.nom}"
                                    itemValue="#{t.id}" />
                            </p:selectOneMenu>
                        </div>

                        <!-- Type -->
                        <div class="p-field" style="margin-bottom: 1rem;">
                            <label for="editType">Type de question *</label>
                            <p:selectOneMenu id="editType" value="#{adminBean.questionSelectionnee.type}"
                                required="true">
                                <f:selectItem itemLabel="Choix Unique" itemValue="CHOIX_UNIQUE" />
                                <f:selectItem itemLabel="Choix Multiple" itemValue="CHOIX_MULTIPLE" />
                            </p:selectOneMenu>
                        </div>

                        <!-- Texte question -->
                        <div class="p-field" style="margin-bottom: 1.5rem;">
                            <label for="editTexte">√ânonc√© de la question *</label>
                            <p:inputTextarea id="editTexte" value="#{adminBean.questionSelectionnee.texte}" rows="3"
                                required="true" maxlength="500" />
                        </div>

                        <!-- SECTION R√âPONSES -->
                        <div style="border-top: 1px solid #e0e0e0; padding-top: 1rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: var(--brand-primary);">R√©ponses</h4>

                            <!-- Liste des r√©ponses -->
                            <ui:repeat value="#{adminBean.reponsesTemp}" var="rep">
                                <div
                                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem; padding: 8px; background: #{rep.correcte ? '#d4edda' : '#f8f9fa'}; border-radius: 6px;">
                                    <p:commandButton icon="#{rep.correcte ? 'pi pi-check-circle' : 'pi pi-circle'}"
                                        action="#{adminBean.toggleCorrect(rep)}" update="editQuestionForm"
                                        styleClass="p-button-rounded p-button-text #{rep.correcte ? 'p-button-success' : 'p-button-secondary'}"
                                        style="flex-shrink: 0;" title="Marquer comme correcte" />
                                    <span
                                        style="flex: 1; #{rep.correcte ? 'font-weight: 600; color: #155724;' : 'color: #495057;'}">
                                        #{rep.texte}
                                    </span>
                                    <p:commandButton icon="pi pi-trash" action="#{adminBean.supprimerReponseTemp(rep)}"
                                        update="editQuestionForm"
                                        styleClass="p-button-rounded p-button-text p-button-danger"
                                        style="flex-shrink: 0;" />
                                </div>
                            </ui:repeat>

                            <!-- Message si aucune r√©ponse -->
                            <h:panelGroup rendered="#{empty adminBean.reponsesTemp}">
                                <div style="text-align: center; padding: 1rem; color: #6c757d; font-style: italic;">
                                    Aucune r√©ponse ajout√©e. Ajoutez au moins 2 r√©ponses ci-dessous.
                                </div>
                            </h:panelGroup>

                            <!-- Formulaire ajout r√©ponse -->
                            <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                                <div style="display: flex; gap: 10px; align-items: flex-end;">
                                    <div style="flex: 1;">
                                        <label for="editRepTexte"
                                            style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Texte de la
                                            r√©ponse</label>
                                        <p:inputText id="editRepTexte" value="#{adminBean.texteNouvelleReponse}"
                                            style="width: 100%;" placeholder="Saisissez une r√©ponse..." />
                                    </div>
                                    <div style="flex-shrink: 0;">
                                        <p:selectBooleanCheckbox id="editRepCorrecte"
                                            value="#{adminBean.nouvelleReponseCorrecte}" />
                                        <label for="editRepCorrecte" style="margin-left: 5px;">Correcte</label>
                                    </div>
                                    <p:commandButton value="Ajouter" icon="pi pi-plus"
                                        action="#{adminBean.ajouterReponseTemp}" update="editQuestionForm"
                                        styleClass="p-button-sm p-button-info" style="flex-shrink: 0;" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: right; margin-top: 1.5rem;">
                        <p:commandButton value="Annuler" icon="pi pi-times"
                            onclick="PF('editQuestionDialog').hide(); return false;" type="button"
                            styleClass="p-button-text" style="margin-right: 10px;" />
                        <p:commandButton value="Enregistrer" icon="pi pi-save" action="#{adminBean.modifierQuestion}"
                            update="questionForm:questionsTable questionForm:messages"
                            oncomplete="if (args &amp;&amp; !args.validationFailed) PF('editQuestionDialog').hide();"
                            styleClass="p-button-success" />
                    </div>
                </h:form>
            </p:dialog>
        </div>
    </div>
</h:body>

</html>